name: Simple Telegram Notification

on:
  push:
    branches: [ "main", "master" ]

jobs:
  notify:
    runs-on: self-hosted
    
    steps:
    - name: Send push notification to Telegram
      shell: powershell
      run: |
        try {
            $botToken = "${{ secrets.TELEGRAM_BOT_TOKEN }}"
            
            if (-not $botToken) {
                Write-Host "‚ùå Bot token topilmadi!"
                exit 1
            }
            
            Write-Host "üîÑ Telegram'ga xabar yuborilmoqda..."
            
            # Telegram API orqali bot subscribers'ni olish
            $telegramUrl = "https://api.telegram.org/bot$botToken"
            $updatesUrl = "$telegramUrl/getUpdates"
            
            $updates = Invoke-RestMethod -Uri $updatesUrl -Method Get -TimeoutSec 10
            
            # Chat ID'larni yig'ish
            $chatIds = @()
            foreach ($update in $updates.result) {
                if ($update.message -and $update.message.chat.id) {
                    $chatId = $update.message.chat.id
                    if ($chatIds -notcontains $chatId) {
                        $chatIds += $chatId
                    }
                }
            }
            
            if ($chatIds.Count -eq 0) {
                Write-Host "‚ö†Ô∏è Hech qanday chat topilmadi. Botga /start yuboring!"
                exit 0
            }
            
            Write-Host "üë• Topilgan foydalanuvchilar: $($chatIds.Count)"
            
            # Xabar tayyorlash
            $message = "üì¢ *GitHub Push Notification*`n`n" +
                      "üìÅ *Repository:* ${{ github.repository }}`n" +
                      "üîß *Commit:* ``${{ github.sha }}```n" +
                      "üë§ *Author:* ${{ github.actor }}`n" +
                      "‚è∞ *Time:* $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n`n" +
                      "‚úÖ *Push muvaffaqiyatli amalga oshirildi!*"
            
            # Har bir chat'ga xabar yuborish
            $successCount = 0
            $errorCount = 0
            
            foreach ($chatId in $chatIds) {
                try {
                    $body = @{
                        chat_id = $chatId
                        text = $message
                        parse_mode = "Markdown"
                    } | ConvertTo-Json -Depth 10
                    
                    $response = Invoke-RestMethod -Uri "$telegramUrl/sendMessage" -Method Post -Body $body -ContentType "application/json" -TimeoutSec 10
                    
                    if ($response.ok) {
                        $successCount++
                        Write-Host "‚úÖ Xabar yuborildi: $chatId"
                    } else {
                        $errorCount++
                        Write-Host "‚ùå Xabar yuborilmadi: $chatId"
                    }
                }
                catch {
                    $errorCount++
                    Write-Host "‚ùå Xatolik ($chatId): $($_.Exception.Message)"
                }
                
                # API limit uchun kichik pauza
                Start-Sleep -Milliseconds 100
            }
            
            Write-Host ""
            Write-Host "üìä Natija:"
            Write-Host "   Muvaffaqiyatli: $successCount"
            Write-Host "   Xatolik: $errorCount"
            Write-Host "   Jami: $($chatIds.Count)"
            
            if ($successCount -gt 0) {
                Write-Host "üéâ Telegram bildirishnoma muvaffaqiyatli yuborildi!"
            } else {
                Write-Host "üòû Hech qanday xabar yuborilmadi."
                exit 1
            }
        }
        catch {
            Write-Host "üí• Umumiy xatolik: $($_.Exception.Message)"
            Write-Host "üîç Tekshiring:"
            Write-Host "   1. Bot token to'g'rimi?"
            Write-Host "   2. Internet aloqasi bormi?"
            Write-Host "   3. Botga /start yubordiingizmi?"
            exit 1
        }
