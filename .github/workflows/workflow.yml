name: Check Bot Updates

on: [push]

jobs:
  check-updates:
    runs-on: self-hosted
    
    steps:
    - name: Check what bot sees
      shell: powershell
      run: |
        $token = "${{ secrets.TELEGRAM_BOT_TOKEN }}"
        $url = "https://api.telegram.org/bot$token/getUpdates"
        
        Write-Host "üîç Checking bot updates..."
        Write-Host "URL: $url"
        
        try {
            $updates = Invoke-RestMethod -Uri $url -Method Get
            Write-Host "‚úÖ API call successful"
            Write-Host "Updates result count: $($updates.result.Count)"
            
            if ($updates.result.Count -eq 0) {
                Write-Host "‚ö†Ô∏è No updates found!"
                Write-Host "Please send /start to your bot in Telegram first!"
            } else {
                Write-Host "üì± Found $($updates.result.Count) updates"
                
                # Har bir update'ni ko'rsatish
                for ($i = 0; $i -lt [Math]::Min(3, $updates.result.Count); $i++) {
                    $update = $updates.result[$i]
                    Write-Host "Update $($i+1):"
                    Write-Host "  Chat ID: $($update.message.chat.id)"
                    Write-Host "  From: $($update.message.from.first_name)"
                    Write-Host "  Text: $($update.message.text)"
                    Write-Host "  Date: $($update.message.date)"
                }
            }
        }
        catch {
            Write-Host "‚ùå API call failed!"
            Write-Host "Error: $($_.Exception.Message)"
            Write-Host "Response: $($_.Exception.Response)"
        }
