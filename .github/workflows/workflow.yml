name: Detailed Deployment

on:
  push:
    branches: [ "main", "master" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Send deployment start notification
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=DEPLOYMENT STARTED | Repository: ${{ github.repository }} | Author: ${{ github.actor }} | Commit: ${{ github.sha }} | Time: %date% %time%"
        
    - name: Send step 1 notification
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=STEP 1/6: Git ma'lumotlari olinmoqda..."
        
    - name: Send step 2 notification  
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=STEP 2/6: Loyiha fayllari tekshirilmoqda..."
        
    - name: Send step 3 notification
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=STEP 3/6: npm install --force jarayoni boshlandi..."
        
    - name: Send step 4 notification
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=STEP 4/6: Backup yaratilmoqda..."
        
    - name: Send step 5 notification
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=STEP 5/6: npm run build jarayoni boshlandi..."
        
    - name: Send step 6 notification
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=STEP 6/6: npm run start - Server ishga tushirilmoqda..."
        
    - name: Execute deployment script
      shell: cmd
      id: deploy
      run: |
        echo Executing deploy.bat...
        if exist "deploy.bat" (
          call deploy.bat
          if %errorlevel% equ 0 (
            echo Deploy script completed successfully
            echo DEPLOY_STATUS=SUCCESS >> %GITHUB_ENV%
          ) else (
            echo Deploy script failed
            echo DEPLOY_STATUS=FAILED >> %GITHUB_ENV%
            exit /b 1
          )
        ) else (
          echo deploy.bat not found!
          echo DEPLOY_STATUS=FAILED >> %GITHUB_ENV%
          exit /b 1
        )
        
    - name: Send detailed success notification
      if: success()
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=DEPLOYMENT SUCCESS | Repository: ${{ github.repository }} | Author: ${{ github.actor }} | ALL STEPS COMPLETED: 1) Git info 2) Project check 3) npm install --force 4) Backup created 5) npm run build 6) npm run start | Status: SUCCESS | Time: %date% %time%"
        
    - name: Send failure notification
      if: failure()
      shell: cmd
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=6135147194" -d "text=DEPLOYMENT FAILED | Repository: ${{ github.repository }} | Author: ${{ github.actor }} | Status: FAILED | Time: %date% %time%"
